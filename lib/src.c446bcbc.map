{"version":3,"sources":["../bundler/index.js","task.coffee","lib.coffee","index.coffee"],"names":[],"mappings":"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","file":"src.c446bcbc.map","sourceRoot":"../src","sourcesContent":["const { spawn } = require('child_process');\nconst { ipcRenderer, remote } = require('electron');\nconst path = require('path');\nconst isRenderer = require('is-electron-renderer');\n\nconst debug = false;\n\nfunction printLine(obj) {\n  let line;\n  // Convert to string if needed\n  if (typeof obj === 'string' || obj instanceof String) {\n    line = obj;\n  } else {\n    line = JSON.stringify(obj);\n  }\n  if (isRenderer) {\n    ipcRenderer.send('bundle-log', line);\n  } else {\n    let newLine = line.replace(\"âœ¨\", \"ðŸŒ¸\");\n    process.stdout.write(newLine);\n  }\n}\n\nasync function printToStdout(child) {\n  child.stdout.then( data => {\n    let line = data.toString('utf8');\n    printLine(line);\n  });\n};\n\nconst runBundler = function(inFile, options={}) {\n  let env, runner, bundlerScript;\n  if (isRenderer) {\n    env = Object.create(remote.process.env);\n    runner = remote.process.argv[0];\n    bundlerScript = remote.getGlobal('bundlerScript')\n  } else {\n    env = Object.create(process.env);\n    runner = process.argv[0];\n    bundlerScript = global.bundlerScript;\n  }\n  env.ELECTRON_RUN_AS_NODE = '1';\n  env.FORCE_COLOR = true;\n\n  const opts = JSON.stringify(options);\n  const proc = spawn(runner, [bundlerScript, inFile, opts], {\n    env: env,\n    stdio: ['pipe','pipe','inherit','ipc']\n  });\n  proc.on('message', (bundle)=>{\n    if (!isRenderer) return;\n    if (debug) printLine(bundle);\n  });\n  printToStdout(proc);\n\n  return proc;\n};\n\nmodule.exports = {runBundler};\n","path = require 'path'\nfs = require 'fs'\n{runBundler} = require '../bundler'\n{ipcRenderer} = require 'electron'\n\nrunTask = (e, data, callback)->\n  ###\n  # This is the function that actually runs a discrete task\n  ###\n\n  callback ?= null\n  {code} = data # The file that has the code in it...\n  dn = path.dirname(path.resolve(code))\n\n  cacheDir = path.join(dn, '.cache')\n  outDir = path.join(cacheDir,'build')\n\n  proc = runBundler(code, {outDir, cacheDir})\n  proc.on 'message', (bundle)->\n    el = document.querySelector(\"#pdf-printer-figure-container\")\n    newEl = document.createElement('div')\n    newEl.id = 'pdf-printer-figure-container'\n    el.parentNode.replaceChild(newEl, el)\n\n    console.log \"Trying to run task\"\n    console.log \"Ready\"\n    console.log bundle\n\n    if bundle.type != 'js'\n      throw \"Only javascript output is supported (for now)\"\n\n    compiledCode = bundle.name\n\n    css = path.join(outDir, 'index.css')\n    if fs.existsSync(css)\n      styles = fs.readFileSync(css, 'utf-8')\n      head = document.querySelector('head')\n      style = document.createElement('style')\n      head.appendChild(style)\n      style.type = 'text/css'\n      style.appendChild(document.createTextNode(styles))\n\n    # Race condition\n    process.chdir(dn)\n    func = require compiledCode\n    # Try to make requires relative to initial dir\n    func newEl, callback\n\nprepareForPrinting = ->\n  el = document.querySelector '#pdf-printer-figure-container>*:first-child'\n  {width, height} = el.getBoundingClientRect()\n  msg = {\n    message: \"Ready to print\"\n    bounds: {width, height: height+2}\n  }\n  ipcRenderer.sendToHost JSON.stringify(msg)\n\nredirectErrors = ->\n  c = remote.getGlobal('console')\n  console.log = c.log\n  console.error = c.error\n  console.warn = c.warn\n\n  # redirect errors to stderr\n  window.addEventListener 'error', (e) ->\n    e.preventDefault()\n    console.error e.error.stack or 'Uncaught ' + e.error\n\nmodule.exports = {runTask, prepareForPrinting, redirectErrors}\n","Promise = require 'bluebird'\nfs = require 'fs'\n{remote, ipcRenderer} = require 'electron'\n{createHash} = require 'crypto'\npath = require 'path'\nd3 = require 'd3-selection'\ncolors = require 'colors/safe'\n\noptions = remote.getGlobal 'options' or {}\noptions.dpi ?= 96\noptions.log = false\n\nwaitForUserInput = (data)->\n  new Promise (resolve, reject)->\n    ipcRenderer.once 'done-waiting', ->resolve(data)\n    ipcRenderer.send 'wait-for-input'\n\nsleep = (data)->\n  new Promise (resolve, reject)->\n    fn = ->resolve(data)\n    setTimeout fn, 1000\n\ngenerateFigure = (task)->\n  main = d3.select \"#pdf-printer-ui-controls\"\n  main.html \"\"\n  ## Set up a webview\n  webview = main.append \"webview\"\n    .attr \"nodeintegration\", true\n    .attr \"src\", \"file://\"+require.resolve(\"../_runner/index.html\")\n    .node()\n\n  new Promise (resolve, reject)->\n    webview.addEventListener 'dom-ready', (e)->\n      webview.send \"run-task\", {\n        code: task.code\n        helpers: task.helpers\n      }\n    webview.addEventListener 'ipc-message', (e)->\n      if event.channel == 'finished'\n        resolve(task)\n\npixelsToMicrons = (px)->\n  Math.ceil(px/96.0*25400)\n\nprintToPDF = (webview, size)->\n  new Promise (resolve, reject)->\n    ###\n    Print the webview to the callback\n    ###\n    el = document.querySelector(\"#pdf-printer-figure-container\")\n    opts = {\n      printBackground: true\n      marginsType: 1\n      pageSize: {\n        height: pixelsToMicrons(size.height*size.scaleFactor)+10\n        width: pixelsToMicrons(size.width*size.scaleFactor)+10\n      }\n    }\n    el.style.transform = \"scale(#{size.scaleFactor})\"\n    el.style.transformOrigin = \"top left\"\n\n    webview.printToPDF opts, (e,data)=>\n      reject(e) if e?\n      resolve(data)\n      el.style.transform = null\n      el.style.transformOrigin = null\n\n\nprintToImage = (webview, opts)->\n  new Promise (resolve, reject)->\n    ###\n    Print the webview to the callback\n    ###\n    opts.format ?= 'png'\n    opts.scaleFactor ?= 1.8\n    opts.quality ?= 90\n    {width,height} = opts\n    width*=opts.scaleFactor\n    height*=opts.scaleFactor\n    rect = {x:0,y:30,width,height}\n    console.log rect\n    webview.capturePage rect, (image)->\n      reject(e) if e?\n      if ['jpeg','jpg'].includes(opts.format)\n        d = image.toJPEG(rect, opts.quality)\n      else\n        d = image.toPNG(opts.scaleFactor)\n      resolve(d)\n\nprintFigureArea = (task)->\n  ###\n  # Function to print webpage\n  ###\n  console.log task\n  opts = task.opts or {}\n  {scaleFactor} = opts\n  scaleFactor ?= 1\n  el = document.querySelector('#pdf-printer-figure-container>*:first-child')\n\n  {width, height} = el.getBoundingClientRect()\n  opts = {width, height, scaleFactor}\n\n  {outfile} = task\n  dir = path.dirname outfile\n  if not fs.existsSync(dir)\n    fs.mkdirSync dir\n  console.log \"Printing to #{outfile}\"\n\n  ext = path.extname(outfile)\n  wc = remote.getCurrentWebContents()\n\n  if ['.jpg','.jpeg','.png'].includes(ext)\n    opts.format = ext.slice(1)\n    buf = await printToImage(wc, opts)\n  else\n    buf = await printToPDF(wc, opts)\n\n  console.log \"#{outfile}\"\n  fs.writeFileSync outfile, buf\n  console.log \"Finished task\"\n\n# Initialize renderer\nclass Printer\n  constructor: (options={})->\n    ###\n    Setup a rendering object\n    ###\n    console.log arguments[0]\n    @cliOptions = {}\n    console.log \"Started renderer\"\n\n    @options = options\n    @options.buildDir ?= ''\n    @tasks = []\n\n\n  task: (fn, funcOrString, opts={})->\n    ###\n    Add a task\n    ###\n    opts.dpi ?= 300\n\n    # Check if we've got a function or string\n    if typeof funcOrString == 'function'\n      throw \"We only support strings now, because we run things in a webview\"\n      func = funcOrString\n    else\n      # Require relative to parent module,\n      # but do it later so errors can be accurately\n      # traced\n      if not path.isAbsolute(funcOrString)\n        func = path.join process.cwd(), funcOrString\n      else\n        func = funcOrString\n      #f = require fn\n      #f(el, cb)\n\n    console.log @options\n    # Apply build directory\n    if fn?\n      if not path.isAbsolute(fn)\n        fn = path.join(@options.buildDir,fn)\n    else\n      fn = \"\"\n\n    h = createHash('md5')\n          .update(fn)\n          .digest('hex')\n\n    @tasks.push\n      outfile: fn\n      code: func\n      helpers: @options.helpers\n      hash: h\n      opts: opts\n    return @\n\n  run: ->\n    # Progress through list of figures, print\n    # each one to file\n    __runTask = (t)->\n      console.log \"#{t.code} â‡’ #{t.outfile}\"\n      p = generateFigure(t)\n\n      if options.waitForUser\n        p = p.then waitForUserInput\n\n      p.then printFigureArea\n        .catch (e)->console.log('Error: '+e)\n\n    Promise\n      .map @tasks, __runTask, concurrency: 1\n\nmodule.exports = {\n  Printer\n  printFigureArea\n  generateFigure\n}\n","{remote, ipcRenderer, webFrame} = require 'electron'\npath = require 'path'\nPromise = require 'bluebird'\nd3 = require 'd3-selection'\n{spawn} = require 'child_process'\n{runTask} = require './task'\n{Printer, printFigureArea} = require(\"./lib.coffee\")\nwindow.Printer = Printer\n\noptions = remote.getGlobal 'options'\n\n# # Print logging statements to both webtools and to command line\n# c1 = remote.getGlobal('console')\n# for i in ['log', 'warn', 'error']\n#   oldFunc = console[i]\n#   console[i] = ->\n#     oldFunc.apply(arguments)\n#     c1[i].apply(arguments)\n\nprocess.exit = remote.app.quit\n\n# redirect errors to stderr\nwindow.addEventListener 'error', (e) ->\n  e.preventDefault()\n  console.error e.error.stack or 'Uncaught ' + e.error\n\ncreateMainPage = null\nisMainPage = null\ntasks = []\n\nbody = d3.select 'body'\n\nzoomContainer = d3.select '#pdf-printer-figure-zoom-container'\nmain = d3.select '#pdf-printer-figure-container'\ncurrentTask = null\n\nreloadWebview = ->\n  wc = remote.getCurrentWebContents()\n  wc.reloadIgnoringCache()\n  webFrame.setZoomLevel(1)\n  console.log \"Reloading...\"\n\ncontrols = d3.select \"#pdf-printer-ui-controls\"\n\ntitle = d3.select '#pdf-printer-ui-controls>h1'\nd3.select '#toggle-dev-tools'\n  .on 'click', ->\n    ipcRenderer.send 'dev-tools'\n    win = require('electron').remote.getCurrentWindow()\n    win.openDevTools()\n\nipcRenderer.on 'show-toolbar', (event, toolbarEnabled)->\n  mode = if toolbarEnabled then 'flex' else 'none'\n  controls.style 'display', mode\n\nsetZoomFactor = (zoom)->\n  webFrame.setZoomLevel(1)\n  z = if zoom == 1 then null else \"scale(#{zoom})\"\n  main\n    .style('transform', z)\n    .style('transform-origin', \"0px 0px\")\n    .style('padding', \"#{20/zoom}px\")\n\nipcRenderer.on 'zoom', (event, zoom)->\n  setZoomFactor(zoom)\n\nipcRenderer.on 'reload', reloadWebview\n\nsharedStart = (array) ->\n  # From\n  # http://stackoverflow.com/questions/1916218/\n  #       find-the-longest-common-starting-substring-in-a-set-of-strings\n  A = array.concat().sort()\n  a1 = A[0]\n  a2 = A[A.length - 1]\n  L = a1.length\n  i = 0\n  while i < L and a1.charAt(i) == a2.charAt(i)\n    i++\n  a1.substring 0, i\n\nopenEditor = (d)->\n  spawn process.EDITOR, [d.code], detached: true\n\nitemSelected = (d)->\n  ### Run a single task ###\n  console.log \"Running task\"\n\n  location.hash = \"##{d.hash}\"\n\n  t = title.html \"\"\n  if tasks.length > 1\n    t.append 'a'\n      .attr 'href','#'\n      .text 'â—€ï¸Ž Back to list'\n      .on 'click', loadEntryPoint(createMainPage)\n  else\n    t.text \"PDF Printer\"\n\n  ### set current task ###\n  d3.select '#print'\n    .on 'click', ->\n      console.log \"Printing figure\"\n      printFigureArea d\n\n  d3.select '#open-editor'\n    .on 'click', ->\n      return unless webview?\n      console.log \"Opening editor\"\n      openEditor d\n\n  d3.selectAll(\"style\").remove()\n  main.html \"\"\n\n  {devToolsEnabled, reload} = remote.getGlobal 'options'\n\n  win = require('electron').remote.getCurrentWindow()\n  if devToolsEnabled\n    win.openDevTools()\n\n  vals = do -> {code, helpers} = d\n  console.log \"Ready to run task\"\n  runTask null, vals, ->\n    console.log \"Finished rendering\"\n\nrenderSpecList = (d)->\n\n  console.log \"Spec list\"\n  # Render spec list from runner\n  el = d3.select @\n    .attr \"class\", \"task-list\"\n  # Find shared starting substring\n  arr = d.tasks.map (d)->d.outfile\n  arr.push d.name\n\n  prefix = sharedStart(arr)\n\n  el.append 'h5'\n    .text prefix\n\n  el.append 'h2'\n    .text d.name.slice(prefix.length)\n\n  sel = el\n    .append 'ul'\n    .selectAll 'li'\n    .data d.tasks\n\n  sel.enter()\n    .append 'li'\n    .append 'a'\n      .attr 'href',(d)->\"##{d.hash}\"\n      .text (d)->d.outfile.slice(prefix.length)\n      .on 'click', itemSelected\n\ncreateMainPage = (runners)->\n  controls.style \"display\", \"none\"\n  # Create a list of tasks\n\n  main = d3.select \"#pdf-printer-figure-container\"\n  main.html \"\"\n  sel = main.selectAll 'div'\n        .data runners\n\n  sel.enter()\n    .append 'div'\n    .attr 'class', 'runner'\n    .each renderSpecList\n\nrunBasedOnHash = (runners)->\n  z = remote.getGlobal('zoom')\n  setZoomFactor z\n\n  _ = runners.map (d)->d.tasks\n  tasks = Array::concat.apply [], _\n\n  # We've only got one possibility,\n  # so we don't need hashes!\n  # We could probably represent this much more cleanly\n  if tasks.length == 1\n    console.log \"Rendering single task\"\n    itemSelected tasks[0]\n    return\n\n  if location.hash.length > 1\n    console.log \"Attempting to navigate to #{location.hash}\"\n    # Check if we can grab a dataset\n    for item in tasks\n      if item.hash == location.hash.slice(1)\n        itemSelected item\n        return\n\n  # If no hash then create main page\n  createMainPage(runners)\n\ngetSpecs = (d)->\n  console.log d\n  res = require(d)\n  Promise.resolve res\n    .then (v)->\n      v.name = d\n      v\n\nloadEntryPoint = (fn)-> ->\n  console.log \"Loading entry point #{fn}\"\n\n  # If we are in spec mode\n  if options.specs?\n    p = Promise.map options.specs, getSpecs\n  else\n    spec = new Printer\n    spec.task options.outfile, options.infile\n    p = Promise.resolve [spec]\n  p.then fn\n\nrunTaskA = (spec)->\n  ## Runner for all tasks\n  console.log \"Running tasks from #{spec}\"\n  taskRunner = require spec\n  Promise.resolve taskRunner\n    .then (t)->t.run()\n\nif options.debug\n  fn = loadEntryPoint(runBasedOnHash)\n  fn()\nelse\n  # Run single tasks\n  if options.specs?\n    console.log \"Running from spec\"\n    p = Promise.map options.specs, runTask, concurrency: 1\n  else\n    taskRunner = new Printer\n    taskRunner.task options.outfile, options.infile\n    p = taskRunner.run()\n  p.then ->\n    console.log \"Done!\"\n    remote.app.quit()\n"]}